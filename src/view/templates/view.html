{% extends "base.html" %}

{% block content %}
{{ super() }}

<!-- CDN do Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- VISUALIZAÇÃO -->
<div id="visualizacao" class="screen">
    <!-- Loading State -->
    <div id="loadingState" style="text-align: center; padding: 60px;">
        <div style="font-size: 1.2em; color: #888;">Carregando dados...</div>
        <div style="margin-top: 16px; color: #666;">Processando análises estatísticas</div>
    </div>

    <!-- Conteúdo Principal (hidden inicialmente) -->
    <div id="mainContent" style="display: none;">
        <div class="viz-grid">
            <!-- Gráfico 1: PCA Scatter -->
            <div class="chart">
                <h3>Distribuição de Clusters (PCA)</h3>
                <canvas id="pcaChart" style="max-height: 300px;"></canvas>
                <div id="pcaInfo" style="margin-top: 16px; font-size: 0.85em; color: #666;"></div>
            </div>

            <!-- Gráfico 2: Correlação -->
            <div class="chart">
                <h3>Potência: Superior vs Inferior</h3>
                <canvas id="correlacaoChart" style="max-height: 300px;"></canvas>
                <div id="correlacaoInfo" style="margin-top: 16px; font-size: 0.85em; color: #666;"></div>
            </div>

            <!-- Gráfico 3: Box Plot Core -->
            <div class="chart">
                <h3>Força do Core por Cluster</h3>
                <canvas id="coreChart" style="max-height: 300px;"></canvas>
                <div id="coreInfo" style="margin-top: 16px; font-size: 0.85em; color: #666;"></div>
            </div>

            <!-- Gráfico 4: Radar -->
            <div class="chart">
                <h3>Perfil Médio por Cluster</h3>
                <canvas id="radarChart" style="max-height: 300px;"></canvas>
                <div id="radarInfo" style="margin-top: 16px; font-size: 0.85em; color: #666;"></div>
            </div>
        </div>

        <!-- Métricas de Qualidade -->
        <div style="background: #111; border: 1px solid #222; border-radius: 8px; padding: 24px; margin-top: 24px;">
            <h3 style="font-size: 1em; color: #fff; margin-bottom: 16px;">Indicadores de Qualidade do Clustering</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
                <div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">Silhouette Score</div>
                    <div id="silhouetteValue" style="font-size: 1.5em; font-weight: 600; color: #4a9eff;">-</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">Separação entre clusters</div>
                </div>
                <div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">Davies-Bouldin Index</div>
                    <div id="daviesBouldinValue" style="font-size: 1.5em; font-weight: 600; color: #10b981;">-</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">Qualidade dos clusters</div>
                </div>
                <div>
                    <div style="font-size: 0.85em; color: #666; margin-bottom: 4px;">Inércia Total</div>
                    <div id="inertiaValue" style="font-size: 1.5em; font-weight: 600; color: #7c3aed;">-</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 4px;">Compactação dos grupos</div>
                </div>
            </div>
        </div>

        <!-- Insights -->
        <div style="background: #111; border: 1px solid #222; border-radius: 8px; padding: 24px; margin-top: 16px;">
            <h3 style="font-size: 1em; color: #fff; margin-bottom: 16px;">Insights Estatísticos</h3>
            <div id="insightsContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; font-size: 0.9em; color: #aaa; line-height: 1.8;">
                <!-- Será preenchido via JS -->
            </div>
        </div>
    </div>
</div>

<script>
// Cores para os clusters
const CORES_CLUSTERS = {
    'Elite': '#10b981',
    'Competitivo': '#4a9eff',
    'Intermediário': '#f59e0b',
    'Iniciante': '#ef4444'
};

let charts = {}; // Armazenar instâncias dos gráficos

// Carregar dados ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
    carregarDados();
});

function carregarDados() {
    try {
        const dados = {{ info | tojson }};

        console.log('Dados recebidos:', dados);
        
        // Ocultar loading e mostrar conteúdo
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        // Criar gráficos
        criarGraficoPCA(dados.pca_data, dados.variance_explained);
        criarGraficoCorrelacao(dados.potencia_data);
        criarGraficoCore(dados.core_data);
        criarGraficoRadar(dados.perfil_data);
        
        // Atualizar métricas
        atualizarMetricas(dados.metricas);
        
        // Atualizar insights
        atualizarInsights(dados.estatisticas);
        
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('loadingState').innerHTML = `
            <div style="color: #ef4444;">
                <div style="font-size: 1.2em;">Erro ao carregar dados</div>
                <div style="margin-top: 8px;">${error.message}</div>
                <button onclick="carregarDados()" style="margin-top: 16px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Tentar Novamente
                </button>
            </div>
        `;
    }
}

function criarGraficoPCA(pca_data, variance) {
    const ctx = document.getElementById('pcaChart').getContext('2d');
    
    const datasets = pca_data.map(grupo => ({
        label: grupo.nivel,
        data: grupo.x.map((x, i) => ({x: x, y: grupo.y[i]})),
        backgroundColor: CORES_CLUSTERS[grupo.nivel] + '80', // 80 = opacidade
        borderColor: CORES_CLUSTERS[grupo.nivel],
        pointRadius: 5,
        pointHoverRadius: 7
    }));
    
    charts.pca = new Chart(ctx, {
        type: 'scatter',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: '#fff' }
                },
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.dataset.label}: (${context.parsed.x.toFixed(2)}, ${context.parsed.y.toFixed(2)})`
                    }
                }
            },
            scales: {
                x: { 
                    title: { display: true, text: `PC1 (${variance.pc1}%)`, color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: '#222' }
                },
                y: { 
                    title: { display: true, text: `PC2 (${variance.pc2}%)`, color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: '#222' }
                }
            }
        }
    });
    
    document.getElementById('pcaInfo').innerHTML = 
        `Variância total explicada: ${variance.total}% dos dados. Mostra separação natural entre grupos.`;
}

function criarGraficoCorrelacao(dados) {
    if (!dados) return;
    
    const ctx = document.getElementById('correlacaoChart').getContext('2d');
    
    const pontos = dados.x.map((x, i) => ({x: x, y: dados.y[i]}));
    
    charts.correlacao = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Atletas',
                data: pontos,
                backgroundColor: '#4a9eff80',
                borderColor: '#4a9eff',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => `Superior: ${context.parsed.x.toFixed(1)}, Inferior: ${context.parsed.y.toFixed(1)}`
                    }
                }
            },
            scales: {
                x: { 
                    title: { display: true, text: 'Potência Superior', color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: '#222' }
                },
                y: { 
                    title: { display: true, text: 'Potência Inferior', color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: '#222' }
                }
            }
        }
    });
    
    document.getElementById('correlacaoInfo').innerHTML = 
        `Correlação: r = ${dados.correlacao} (p < ${dados.p_value}). ${dados.correlacao > 0.7 ? 'Correlação forte positiva' : 'Correlação moderada'}.`;
}

function criarGraficoCore(dados) {
    if (!dados) return;
    
    const ctx = document.getElementById('coreChart').getContext('2d');
    
    charts.core = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dados.map(d => d.nivel),
            datasets: [{
                label: 'Abdominais (média)',
                data: dados.map(d => d.media),
                backgroundColor: dados.map(d => CORES_CLUSTERS[d.nivel] + '80'),
                borderColor: dados.map(d => CORES_CLUSTERS[d.nivel]),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const item = dados[context.dataIndex];
                            return `${item.media.toFixed(1)} ± ${item.std.toFixed(1)} rep/min`;
                        }
                    }
                }
            },
            scales: {
                x: { ticks: { color: '#888' }, grid: { display: false } },
                y: { 
                    title: { display: true, text: 'Repetições/minuto', color: '#888' },
                    ticks: { color: '#888' },
                    grid: { color: '#222' }
                }
            }
        }
    });
    
    document.getElementById('coreInfo').innerHTML = 
        'Diferença significativa entre clusters. Core forte distingue atletas de elite.';
}

function criarGraficoRadar(dados) {
    if (!dados) return;
    
    const ctx = document.getElementById('radarChart').getContext('2d');
    
    const datasets = dados.map(grupo => ({
        label: grupo.nivel,
        data: grupo.valores,
        backgroundColor: CORES_CLUSTERS[grupo.nivel] + '40',
        borderColor: CORES_CLUSTERS[grupo.nivel],
        borderWidth: 2,
        pointBackgroundColor: CORES_CLUSTERS[grupo.nivel]
    }));
    
    charts.radar = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: dados[0].features.map(f => f.replace('_', ' ').toUpperCase()),
            datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { 
                    display: true,
                    labels: { color: '#fff' }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { color: '#888', backdropColor: 'transparent' },
                    grid: { color: '#222' },
                    pointLabels: { color: '#888' }
                }
            }
        }
    });
    
    document.getElementById('radarInfo').innerHTML = 
        'Atletas elite apresentam desenvolvimento homogêneo em todas as dimensões.';
}

function atualizarMetricas(metricas) {
    document.getElementById('silhouetteValue').textContent = metricas.silhouette;
    document.getElementById('daviesBouldinValue').textContent = metricas.davies_bouldin;
    document.getElementById('inertiaValue').textContent = metricas.inertia.toLocaleString();
}

function atualizarInsights(stats) {
    const container = document.getElementById('insightsContainer');
    container.innerHTML = `
        <div>
            <strong style="color: #fff;">Distribuição de Atletas:</strong><br>
            ${Object.entries(stats.distribuicao).map(([nivel, qtd]) => 
                `${nivel}: ${qtd} atletas`
            ).join('<br>')}
        </div>
        <div>
            <strong style="color: #fff;">Total de Atletas:</strong><br>
            ${stats.total_atletas} atletas analisados
        </div>
        <div>
            <strong style="color: #fff;">Recomendações gerais:</strong><br>
            Elite: manutenção + especialização<br>
            Competitivo: força máxima + técnica<br>
            Intermediário/Iniciante: base + volume
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', function() {
  const navItem = document.querySelector('.view-nav');
  const activeNavItem = document.querySelector('.nav-btn.active');
  
  if (navItem) {
    navItem.classList.add('active');
  }
  
  if (activeNavItem) {
    activeNavItem.classList.remove('active');
  }
});
</script>

<style>
.viz-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 24px;
}

.chart {
    background: #0a0a0a;
    border: 1px solid #222;
    border-radius: 8px;
    padding: 20px;
}

.chart h3 {
    font-size: 1em;
    color: #fff;
    margin: 0 0 16px 0;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}
</style>

{% endblock %}