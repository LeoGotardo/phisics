{% extends "base.html" %}

{% block content %}
{{ super() }}

<!-- ANÁLISE -->
<div id="analise" class="screen">
    <!-- Filtros -->
    <div class="filters">
        <form id="filterForm" method="GET" action="{{ url_for('renderReview') }}" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <!-- Busca por nome -->
            <input 
                type="text" 
                name="query" 
                id="queryInput"
                placeholder="Buscar por nome..." 
                value="{{ athletes.filters.query }}"
                style="padding: 10px 16px; background: #111; border: 1px solid #222; border-radius: 6px; color: #e0e0e0; font-size: 0.9em; flex: 1; min-width: 200px;"
            >
            
            <!-- Filtro por cluster -->
            <select name="cluster" id="clusterSelect">
                <option value="all" {% if athletes.filters.cluster == 'all' %}selected{% endif %}>Todos os Clusters</option>
                <option value="elite" {% if athletes.filters.cluster == 'elite' %}selected{% endif %}>Elite</option>
                <option value="competitivo" {% if athletes.filters.cluster == 'competitivo' %}selected{% endif %}>Competitivo</option>
                <option value="intermediario" {% if athletes.filters.cluster in ['intermediario', 'intermediário'] %}selected{% endif %}>Intermediário</option>
                <option value="iniciante" {% if athletes.filters.cluster == 'iniciante' %}selected{% endif %}>Iniciante</option>
            </select>
            
            <!-- Filtro por idade - CORRIGIDO -->
            <select name="ageRange" id="ageRangeSelect">
                <option value="all" {% if athletes.filters.ageRange == 'all' %}selected{% endif %}>Todas as Idades</option>
                <option value="10-18" {% if athletes.filters.ageRange == '10-18' %}selected{% endif %}>10-18 anos</option>
                <option value="19-29" {% if athletes.filters.ageRange == '19-29' %}selected{% endif %}>19-29 anos</option>
                <option value="30+" {% if athletes.filters.ageRange == '30+' %}selected{% endif %}>30+ anos</option>
            </select>
            
            <!-- Ordenação -->
            <select name="sort" id="sortSelect">
                <option value="nome" {% if athletes.filters.sort == 'nome' %}selected{% endif %}>Nome</option>
                <option value="altura" {% if athletes.filters.sort == 'altura' %}selected{% endif %}>Altura</option>
                <option value="arremesso" {% if athletes.filters.sort == 'arremesso' %}selected{% endif %}>Arremesso</option>
                <option value="saltoHorizontal" {% if athletes.filters.sort == 'saltoHorizontal' %}selected{% endif %}>Salto</option>
                <option value="abdominais" {% if athletes.filters.sort == 'abdominais' %}selected{% endif %}>Abdominais</option>
                <option value="cluster" {% if athletes.filters.sort == 'cluster' %}selected{% endif %}>Cluster</option>
            </select>
            
            <!-- Ordem -->
            <select name="sortOrder" id="sortOrderSelect">
                <option value="asc" {% if athletes.filters.sortOrder == 'asc' %}selected{% endif %}>Crescente</option>
                <option value="desc" {% if athletes.filters.sortOrder == 'desc' %}selected{% endif %}>Decrescente</option>
            </select>
            
            <!-- Botão de busca -->
            <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">
                <i class="fas fa-search"></i> Buscar
            </button>
            
            <!-- Limpar filtros -->
            <button type="button" class="btn btn-secondary" onclick="limparFiltros()" style="padding: 10px 20px;">
                <i class="fas fa-times"></i> Limpar
            </button>
        </form>
    </div>

    <!-- Tabela -->
    <div class="table-container">
        <div class="table-header">
            <div>#</div>
            <div>Nome</div>
            <div>Altura (cm)</div>
            <div>Envergadura (cm)</div>
            <div>Arremesso (cm)</div>
            <div>Salto (cm)</div>
            <div>Abdom (rep/min)</div>
            <div>Cluster</div>
            <div>Ações</div>
        </div>

        {% if athletes['items']|length == 0 %}
        <div class="table-row" style="display: block; text-align: center; padding: 40px;">
            <div style="font-size: 1.1em; color: #888;">
                <i class="fas fa-search"></i><br>
                Nenhum atleta encontrado
            </div>
        </div>
        {% else %}
        {% for athlete in athletes['items'] %}
        <div class="table-row" id="row-{{ athlete.id }}">
            <div class="rank">{{ loop.index + (athletes.pagination.currentPage - 1) * athletes.pagination.perPage }}</div>
            <div class="name">
                {{ athlete.nome }}
                <div class="sub">{{ athlete.idade }} anos, {{ athlete.sexo }}</div>
            </div>
            
            <div class="metric">{{ "%.1f"|format(athlete.altura) }}</div>
            <div class="metric">{{ "%.1f"|format(athlete.envergadura) }}</div>
            <div class="metric">{{ "%.1f"|format(athlete.arremesso) }}</div>
            <div class="metric">{{ "%.1f"|format(athlete.saltoHorizontal) }}</div>
            <div class="metric">{{ athlete.abdominais }}</div>
            <div>
                <span class="badge badge-{{ athlete.cluster_name.lower() }}">{{ athlete.cluster_name }}</span>
            </div>
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button 
                    class="btn-icon" 
                    onclick="editarAtleta('{{ athlete.id }}')"
                    title="Editar"
                >
                    <i class="fas fa-edit"></i>
                </button>
                <button 
                    class="btn-icon btn-danger" 
                    onclick="excluirAtleta('{{ athlete.id }}', '{{ athlete.nome }}')"
                    title="Excluir"
                >
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- Paginação -->
    {% if athletes.pagination.totalPages > 1 %}
    <div class="pagination">
        <!-- Primeira página -->
        {% if athletes.pagination.showFirst %}
        <a href="?page=1&sort={{ athletes.filters.sort }}&sortOrder={{ athletes.filters.sortOrder }}&query={{ athletes.filters.query }}&cluster={{ athletes.filters.cluster }}&ageRange={{ athletes.filters.ageRange }}" class="page-link">1</a>
        {% if athletes.pagination.showLeftEllipsis %}
        <span class="page-ellipsis">...</span>
        {% endif %}
        {% endif %}
        
        <!-- Páginas visíveis -->
        {% for page_num in athletes.pagination.visiblePages %}
        <a 
            href="?page={{ page_num }}&sort={{ athletes.filters.sort }}&sortOrder={{ athletes.filters.sortOrder }}&query={{ athletes.filters.query }}&cluster={{ athletes.filters.cluster }}&ageRange={{ athletes.filters.ageRange }}" 
            class="page-link {% if page_num == athletes.pagination.currentPage %}active{% endif %}"
        >
            {{ page_num }}
        </a>
        {% endfor %}
        
        <!-- Última página -->
        {% if athletes.pagination.showLast %}
        {% if athletes.pagination.showRightEllipsis %}
        <span class="page-ellipsis">...</span>
        {% endif %}
        <a href="?page={{ athletes.pagination.totalPages }}&sort={{ athletes.filters.sort }}&sortOrder={{ athletes.filters.sortOrder }}&query={{ athletes.filters.query }}&cluster={{ athletes.filters.cluster }}&ageRange={{ athletes.filters.ageRange }}" class="page-link">{{ athletes.pagination.totalPages }}</a>
        {% endif %}
    </div>
    
    <div style="text-align: center; margin-top: 16px; color: #888; font-size: 0.9em;">
        Mostrando {{ athletes['items']|length }} de {{ athletes.pagination.total }} atletas
        {% if athletes.filters.ageRange != 'all' %}
        (Faixa: {{ athletes.filters.ageRange }})
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
.btn-icon {
    background: transparent;
    border: 1px solid #444;
    color: #888;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-icon:hover {
    background: #222;
    color: #fff;
    border-color: #666;
}

.btn-icon.btn-danger:hover {
    background: #dc2626;
    border-color: #dc2626;
    color: #fff;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 24px;
}

.page-link {
    padding: 8px 12px;
    background: #111;
    border: 1px solid #222;
    border-radius: 6px;
    color: #888;
    text-decoration: none;
    transition: all 0.2s;
}

.page-link:hover {
    background: #222;
    color: #fff;
}

.page-link.active {
    background: #4a9eff;
    border-color: #4a9eff;
    color: #fff;
}

.page-ellipsis {
    padding: 8px 12px;
    color: #666;
}

.badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
    text-align: center;
}

.badge-elite { background: #4a9eff; color: #000; }
.badge-competitivo { background: #7c3aed; color: #fff; }
.badge-intermediário { background: #10b981; color: #000; }
.badge-iniciante { background: #6b7280; color: #fff; }
</style>

<script>
// Auto-submit quando os selects mudarem
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterForm');
    const clusterSelect = document.getElementById('clusterSelect');
    const ageRangeSelect = document.getElementById('ageRangeSelect');
    const sortSelect = document.getElementById('sortSelect');
    const sortOrderSelect = document.getElementById('sortOrderSelect');
    
    // Função para fazer submit preservando todos os valores
    function autoSubmit() {
        form.submit();
    }
    
    // Adicionar evento de mudança aos selects
    clusterSelect.addEventListener('change', autoSubmit);
    ageRangeSelect.addEventListener('change', autoSubmit);
    sortSelect.addEventListener('change', autoSubmit);
    sortOrderSelect.addEventListener('change', autoSubmit);
    
    // Permitir busca com Enter no campo de texto
    const queryInput = document.getElementById('queryInput');
    queryInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            form.submit();
        }
    });
    
    // Marcar nav como ativo
    const navItem = document.querySelector('.review-nav');
    const activeNavItem = document.querySelector('.nav-btn.active');
    
    if (navItem) {
        navItem.classList.add('active');
    }
    
    if (activeNavItem && !activeNavItem.classList.contains('review-nav')) {
        activeNavItem.classList.remove('active');
    }
    
    // Adicionar transição às linhas
    document.querySelectorAll('.table-row[id^="row-"]').forEach(row => {
        row.style.transition = 'all 0.3s ease';
    });
});

function limparFiltros() {
    window.location.href = '{{ url_for("renderReview") }}';
}

async function editarAtleta(id) {
    window.location.href = `/atleta/editar/${id}`;
}

async function excluirAtleta(id, nome) {
    if (!confirm(`Tem certeza que deseja excluir o atleta "${nome}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/atleta/excluir/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            // Remover linha da tabela com animação
            const row = document.getElementById(`row-${id}`);
            row.style.opacity = '0';
            row.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                row.remove();
                
                // Recarregar página se não houver mais atletas
                const rows = document.querySelectorAll('.table-row[id^="row-"]');
                if (rows.length === 0) {
                    window.location.reload();
                }
            }, 300);
            
            alert(`Atleta "${nome}" excluído com sucesso!`);
        } else {
            const error = await response.text();
            alert(`Erro ao excluir atleta: ${error}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao excluir atleta. Tente novamente.');
    }
}

// FUNÇÕES DE EXPORTAÇÃO CORRIGIDAS

async function exportarDados() {
    try {
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...';
        
        // Exportar apenas CSV
        const response = await fetch('/exportData?full_data=false', {
            method: 'GET'
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        // Obter o arquivo como blob
        const blob = await response.blob();
        
        // Criar URL temporária para download
        const url = window.URL.createObjectURL(blob);
        
        // Criar elemento <a> temporário para iniciar download
        const a = document.createElement('a');
        a.href = url;
        a.download = `talent_scout_dados_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        
        // Limpar
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Mostrar mensagem de sucesso
        btn.innerHTML = '<i class="fas fa-check"></i> Exportado!';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Erro ao exportar dados:', error);
        alert('Erro ao exportar dados: ' + error.message);
        
        // Restaurar botão
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-file-csv"></i> Exportar CSV';
        btn.disabled = false;
    }
}

async function exportarCompleto() {
    try {
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando ZIP...';
        
        // Exportar pacote completo (CSV + gráficos + PDF)
        const response = await fetch('/exportData?full_data=true', {
            method: 'GET'
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        // Obter o arquivo como blob
        const blob = await response.blob();
        
        // Criar URL temporária para download
        const url = window.URL.createObjectURL(blob);
        
        // Criar elemento <a> temporário para iniciar download
        const a = document.createElement('a');
        a.href = url;
        a.download = `talent_scout_completo_${new Date().toISOString().split('T')[0]}.zip`;
        document.body.appendChild(a);
        a.click();
        
        // Limpar
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Mostrar mensagem de sucesso
        btn.innerHTML = '<i class="fas fa-check"></i> Exportado!';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Erro ao exportar pacote completo: ' + error.message);
        
        // Restaurar botão
        const btn = event.target;
        btn.innerHTML = '<i class="fas fa-file-archive"></i> Exportar Completo (ZIP)';
        btn.disabled = false;
    }
}
</script>

{% endblock %}