{% extends "base.html" %} 

{% block content %} 
{{ super() }}

<!-- CADASTRO -->
<div id="cadastro" class="screen">
  <form id="athleteForm" action="{{ url_for('renderCadastro') }}" method="post">
    <div class="form-section">
      <h3>Dados Pessoais</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Nome</label>
          <input type="text" id="nome" required />
        </div>
        <div class="form-group">
          <label>Data de Nascimento</label>
          <input type="date" id="dataNascimento" required />
        </div>
        <div class="form-group">
          <label>Sexo</label>
          <select id="sexo" required>
            <option value="">Selecione</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
      </div>
    </div>

    <div class="fileDialog"></div>

    <div class="form-section">
      <h3>Antropometria</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Altura (cm)</label>
          <input type="number" id="altura" step="0.1" required />
        </div>
        <div class="form-group">
          <label>Envergadura (cm)</label>
          <input type="number" id="envergadura" step="0.1" />
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3>Testes de Aptid√£o</h3>
      <div class="form-grid">
        <div class="form-group">
          <label>Arremesso (cm)</label>
          <input type="number" id="arremesso" step="0.1" required />
        </div>
        <div class="form-group">
          <label>Salto Horizontal (cm)</label>
          <input type="number" id="saltoHorizontal" step="0.1" required />
        </div>
        <div class="form-group">
          <label>Abdominais (rep/min)</label>
          <input type="number" id="abdominais" required />
        </div>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="btn btn-secondary">Limpar</button>
      <button type="submit" class="btn btn-primary">Salvar</button>
    </div>
  </form>

  <button type="button" class="btn btn-secondary" onclick="loadCSV()">
    Carregar Dados
  </button>
</div>
{% endblock %} 

{% block scripts %} 
{{ super() }}

<script>
function loadCSV() {
    // Criar o overlay do dialog
    const overlay = document.createElement("div");
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    `;

    // Criar o dialog
    const dialog = document.createElement("div");
    dialog.style.cssText = `
        background: #1a1a1a;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5);
        max-width: 500px;
        width: 90%;
        border: 1px solid #333;
    `;

    // Conte√∫do do dialog
    dialog.innerHTML = `
        <h2 style="margin-top: 0; color: #fff; font-size: 1.5em;">üìä Importar arquivo CSV</h2>
        <p style="color: #aaa; margin-bottom: 20px; font-size: 0.95em;">
            Selecione um arquivo CSV com os dados dos atletas
        </p>

        <div style="
            border: 2px dashed #444;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            background: #0a0a0a;
            transition: all 0.3s;
            cursor: pointer;
        " id="dropZone">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3em; color: #666; margin-bottom: 15px;"></i>
            <p style="color: #888; margin: 10px 0;">
                Clique para selecionar ou arraste o arquivo aqui
            </p>
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
        </div>

        <div id="fileInfo" style="
            display: none;
            background: #111;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        ">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-csv" style="font-size: 2em; color: #10b981;"></i>
                <div style="flex: 1;">
                    <div id="fileName" style="color: #fff; font-weight: 500; margin-bottom: 4px;"></div>
                    <div id="fileSize" style="color: #888; font-size: 0.85em;"></div>
                </div>
                <button id="removeFile" style="
                    background: transparent;
                    border: none;
                    color: #ef4444;
                    cursor: pointer;
                    font-size: 1.2em;
                    padding: 5px;
                ">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div id="progressBar" style="
            display: none;
            background: #111;
            border-radius: 6px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        ">
            <div id="progress" style="
                background: linear-gradient(90deg, #4a9eff, #10b981);
                height: 100%;
                width: 0%;
                transition: width 0.3s;
            "></div>
        </div>

        <div id="progressText" style="
            display: none;
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 15px;
        "></div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="cancelarBtn" class="btn btn-secondary">
                Cancelar
            </button>
            
            <button id="importarBtn" class="btn btn-primary" disabled>
                <i class="fas fa-upload"></i> Importar
            </button>
        </div>

        <div style="
            margin-top: 20px;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
        ">
            <p style="color: #888; font-size: 0.85em; margin: 0;">
                <strong style="color: #fff;">‚ÑπÔ∏è Formato esperado:</strong><br>
                O CSV deve conter as colunas: nome, dataNascimento, sexo, altura, envergadura, arremesso, saltoHorizontal, abdominais
            </p>
        </div>
    `;

    overlay.appendChild(dialog);
    document.body.appendChild(overlay);

    // Elementos
    const fileInput = document.getElementById("csvFileInput");
    const dropZone = document.getElementById("dropZone");
    const fileInfo = document.getElementById("fileInfo");
    const importarBtn = document.getElementById("importarBtn");
    const cancelarBtn = document.getElementById("cancelarBtn");
    const removeFileBtn = document.getElementById("removeFile");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    let selectedFile = null;

    // Fun√ß√£o para fechar dialog
    function fecharDialog() {
        document.body.removeChild(overlay);
    }

    // Click na drop zone
    dropZone.addEventListener("click", () => {
        fileInput.click();
    });

    // Drag & Drop
    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#4a9eff";
        dropZone.style.background = "#0f0f1f";
    });

    dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#444";
        dropZone.style.background = "#0a0a0a";
    });

    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.style.borderColor = "#444";
        dropZone.style.background = "#0a0a0a";
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // Sele√ß√£o de arquivo
    fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFileSelect(file);
        }
    });

    // Processar arquivo selecionado
    function handleFileSelect(file) {
        // Validar extens√£o
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert("Por favor, selecione apenas arquivos CSV");
            return;
        }

        selectedFile = file;

        // Mostrar informa√ß√µes do arquivo
        fileInfo.style.display = "block";
        dropZone.style.display = "none";
        document.getElementById("fileName").textContent = file.name;
        document.getElementById("fileSize").textContent = `${(file.size / 1024).toFixed(2)} KB`;
        
        // Habilitar bot√£o de importar
        importarBtn.disabled = false;
    }

    // Remover arquivo
    removeFileBtn.addEventListener("click", () => {
        selectedFile = null;
        fileInput.value = "";
        fileInfo.style.display = "none";
        dropZone.style.display = "block";
        importarBtn.disabled = true;
    });

    // Cancelar
    cancelarBtn.addEventListener("click", fecharDialog);

    // Importar
    importarBtn.addEventListener("click", async () => {
        if (!selectedFile) {
            alert("Por favor, selecione um arquivo CSV");
            return;
        }

        // Criar FormData
        const formData = new FormData();
        formData.append('csvFile', selectedFile);

        // Desabilitar bot√µes
        importarBtn.disabled = true;
        cancelarBtn.disabled = true;
        importarBtn.textContent = "Importando...";
        
        // Mostrar progresso
        progressBar.style.display = "block";
        progressText.style.display = "block";
        progressText.textContent = "Enviando arquivo...";
        document.getElementById("progress").style.width = "30%";

        try {
            // Enviar para o backend
            const response = await fetch('/loadCSVData', {
                method: 'POST',
                body: formData
            });

            // Atualizar progresso
            document.getElementById("progress").style.width = "70%";
            progressText.textContent = "Processando dados...";

            if (response.ok) {
                // Sucesso
                document.getElementById("progress").style.width = "100%";
                progressText.textContent = "‚úì Importa√ß√£o conclu√≠da!";
                progressText.style.color = "#10b981";
                
                // Aguardar um pouco e recarregar p√°gina
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                // Erro do servidor
                const errorText = await response.text();
                throw new Error(errorText || 'Erro ao importar arquivo');
            }
            
        } catch (error) {
            console.error('Erro ao enviar arquivo:', error);
            
            // Mostrar erro
            progressText.textContent = "‚úó Erro ao importar";
            progressText.style.color = "#ef4444";
            document.getElementById("progress").style.background = "#ef4444";
            
            alert(`Erro ao importar CSV:\n${error.message}\n\nVerifique se o formato do arquivo est√° correto.`);
            
            // Resetar UI
            importarBtn.disabled = false;
            cancelarBtn.disabled = false;
            importarBtn.innerHTML = '<i class="fas fa-upload"></i> Importar';
            
            setTimeout(() => {
                progressBar.style.display = "none";
                progressText.style.display = "none";
                document.getElementById("progress").style.width = "0%";
                document.getElementById("progress").style.background = "linear-gradient(90deg, #4a9eff, #10b981)";
            }, 3000);
        }
    });

    // Fechar ao clicar fora do dialog
    overlay.addEventListener("click", (e) => {
        if (e.target === overlay) {
            fecharDialog();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
  const navItem = document.querySelector('.cadastro-nav');
  const activeNavItem = document.querySelector('.nav-btn.active');
  
  if (navItem) {
    navItem.classList.add('active');
  }
  
  if (activeNavItem) {
    activeNavItem.classList.remove('active');
  }
});
</script>
{% endblock %}
